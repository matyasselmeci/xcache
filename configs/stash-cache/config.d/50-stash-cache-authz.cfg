#
# Configure authorization for the StashCache cache server.
#
# **********************************************************************
# * WARNING: DO NOT EDIT THIS FILE.  IT WILL BE OVERWRITTEN ON UPGRADE *
# **********************************************************************
#
# This file is part of the StashCache Daemon
# https://opensciencegrid.org/docs/data/stashcache/overview/

# Enable the authorization module, even if we have an unauthenticated instance.
ofs.authorize 1
# Log both successes and failures in authorization.
acc.audit deny grant

# Allow connections from all hosts; sec.protocol is overwritten later.
xrd.allow host *
sec.protocol host


# Apply the auto-generated cache authorizations only in the case
# where we are one of the two StashCache templates.
if named stash-cache

   sec.protbind * none
fi

# xrootd config does not do nested "unqualified" ifs
if defined ?StashCacheAuthfile && named stash-cache-auth
   acc.authdb $StashCacheAuthfile
# nor negations ("!")
else if named stash-cache-auth
   # This authfile is automatically generated by stash-cache-authfile.service
   acc.authdb /run/stash-cache-auth/Authfile
fi

if defined ?StashCachePublicAuthfile && named stash-cache
   acc.authdb $StashCachePublicAuthfile
else if named stash-cache
   # The unauthenticated instance uses a separate auth file from the
   # authenticated instance; file is generated by stash-cache-authfile.service
   acc.authdb /run/stash-cache/Authfile
fi


# Authorizations for remote debugging; this file does not currently ship with
# the OSG packaging; see SOFTWARE-3490.
xrootd.diglib * /etc/xrootd/digauth.cfg

# Allow scitokens on all ports, all protocols
if defined ?StashCacheSciTokensConf
    ofs.authlib ++ libXrdAccSciTokens.so config=$StashCacheSciTokensConf
else
    ofs.authlib ++ libXrdAccSciTokens.so config=/run/stash-cache-auth/scitokens.conf
fi

# Pass the bearer token to the Xrootd authorization framework.
http.header2cgi Authorization authz
